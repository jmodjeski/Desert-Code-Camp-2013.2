extends layout

block head
	link(rel="import", href="/elements/framework-clock.html")
	link(rel="import", href="/elements/framework-participant.html")
	link(rel="import", href="/elements/framework-resource.html")

block content
	h1 #{meeting.title} 
	h6 (#{meeting.id}) | 
		a(href="/analytics/#{meeting.id}") analytics

	polymer-element(
		name="participant-rows"
		extends="framework-resource"
	)
		template
			div
				template(repeat="{{p in participants}}")
					.row
						framework-participant(
							participant="{{p}}"
							meetingid="#{meeting.id}"
						)
				.row
					framework-participant(
						id="newParticipant"
						meetingid="#{meeting.id}"
						on-add-complete="resetDefaults"
					)
		script.
			Polymer("participant-rows", {
				publish: {
					meetingId: ''
				},
				url: '/api/meetings/#{meetingId}/participants',
				created: function () {
					if (this.url.indexOf('#{meetingId}') > 0)
						this.url = this.url.replace('#{meetingId}', this.meetingId);
					this.participants = [];
				},
				parse: function (data) {
					return _.defaults({
						participants: this.participants
					}, data);
				},
				resetDefaults: function (e, data) {
					this.participants.push(data.data);
					this.$.newParticipant.resetDefaults();
				}
			})

	polymer-element(
		name="participant-resource"
		extends="framework-resource"
	)
		script.
			Polymer("participant-resource", {
				publish: {
					meetingId: ''
				},
				url: '/api/meetings/#{meetingId}/participants',
				created: function () {
					if (this.url.indexOf('#{meetingId}') > 0)
						this.url = this.url.replace('#{meetingId}', this.meetingId);
					alert('participants')
					this.participants = [];
				},
				parse: function (data) {
					return _.defaults({
						participants: this.participants
					}, data);
				}
			})
	
	polymer-element(name="meeting-detail-app")
		template
			.row
				.col-md-4.col-md-offset-1
					framework-clock(id="start")
				.col-md-4.col-md-offset-2
					framework-clock(id="stop")

			.row
				participant-rows(
					id="participants"
					meetingid="#{meeting.id}"
					on-fetch-complete="populateParticipants"
				)

		script.
			Polymer("meeting-detail-app", {
				publish: {
					meetingId: ''
				},

				created:function(){
					var self = this;
				},

				meetingIdChanged: function(){
					var self = this;
					self.initialize();
				},

				initialize: function(){
					var self = this;
					if (self.$.participants.url.indexOf('//') > 0) // This is a dirty hack
						self.$.participants.url = self.$.participants.url.replace('//', '/' + self.$.participants.meetingId + '/');
					self.$.participants.fetch();
				},

				populateParticipants: function (e, sender, detail) {
					this.$.participants.participants = sender.data;
				},

				toggleStartClock: function(){
					var self = this;
					self.$.start.toggle();
				},

				toggleStopClock: function(){
					var self = this;
					self.$.stop.toggle();
				}
			})

	meeting-detail-app(meetingid="#{id}")

